<!doctype html>
<html>

<head>
	<title>QUnit: Image Load</title>
	<link rel="stylesheet" href="qunit/qunit.css" />
	<style>img { display: block; }</style>

	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
	<script src="../ahpi.imgload.js"></script>
	<script src="qunit/qunit.js"></script>
	<script>
(function () {

var img = new Image();
img.onerror = img.onload = function () { runTests(); };
img.src = 'cached.gif';

function runTests() {
	test("Image load event (Normal)", function () {
		stop(1000);
		expect(2);

		var $normal = $('#normal');
		$normal.bind('load', function (event) {
			ok(true, "Load event fired");
			$normal.unbind('load');
			ok(!$normal.data('events'), 'Load event unbound');
			start();
		});
	});

	test("Image load event (Cached)", function () {
		stop(1000);
		expect(2);

		var $cached = $('#cached').attr('src', 'cached.gif');
		$cached.bind('load', function (event) {
			ok(!('offsetX' in event), "Load event fired");
			$cached.unbind('load');
			ok(!$cached.data('events'), 'Load event unbound');
			start();
		});
	});

	test("Bind with eventData (Cached)", function () {
		stop(1000);
		expect(3);

		var $cached = $('#cached');
		$cached.bind('load', {
			eventdata: 7
		}, function (event) {
			ok(true, "Load event fired");
			ok(event.data.eventdata === 7, "eventData is available");
			$cached.unbind('load');
			ok(!$cached.data('events'), 'Load event unbound');
			start();
		});
	});

	test("Triggered image load event (Cached)", function () {
		stop(1000);
		expect(3);

		var $cached = $('#cached');
		$cached.bind('load', function (event, triggered) {
			if (!triggered) {
				ok(true, "Load event fired");
				$(this).trigger('load', [true]);
			} else {
				ok(true, "Triggerd load event fired");
				$cached.unbind('load');
				ok(!$cached.data('events'), 'Load event unbound');
				start();
			}
		});
	});

	test("Image src change load event (Cached)", function () {
		stop(1000);
		expect(6);

		var i = 0,
			 $cached = $('#cached');
		$cached.bind('load', function (event) {

			if (0 === i) {
				ok(true, i + ": Load event fired (cached.gif)");
				ok(!('offsetX' in event), i + ": Triggered load event fired");
				$cached[0].src = 'normal.gif';
				i++;
			} else if (1 === i) {
				ok(true, i + ": Load event fired (normal.gif)");
				ok('offsetX' in event, i + ": Browser load event fired");
				$cached[0].src = 'cached.gif';
				i++;
			} else {
				ok(true, i + ": Load event fired (cached.gif again)");
				$cached.unbind('load');
				ok(!$cached.data('events'), i + ': Load event unbound');
				start();
			}
		});
	});

	test("Image load event (Data URI)", function () {
		stop(1000);
		expect(2);

		var $datauri = $('#datauri');
		$datauri.bind('error', function () {
			ok(true, "Data URI not supported");
			$datauri.unbind('load error');
			ok(!$datauri.data('events'), 'Load and error event unbound');
			start();
		});
		$datauri.bind('load', function () {
			ok(true, "Load event fired");
			$datauri.unbind('load error');
			ok(!$datauri.data('events'), 'Load and error event unbound');
			start();
		});
	});
}

}());
	</script>

</head>

<body>

<p>
	<img id="normal" src="normal.gif" />
	<img id="cached" src="" />
	<img id="datauri" src="data:image/gif;base64,R0lGODdhGwAPAIAAAP///wAAACwAAAAAGwAPAAACN4SPqcvtD08IaIKJrclab+pdlDR+FViK50qq7Wu2XOjGJreEOmrDteqhCUed1E6R8RWTkaYzUgAAOw==" />
	<a href="../ahpi.imgload.js">ahpi.imgload.js Source</a>
</p>

<ol id="qunit-tests"></ol>
</body>

</html>
